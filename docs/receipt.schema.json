{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/afewell-hh/hoss/blob/main/docs/receipt.schema.json",
  "title": "Promotion Receipt",
  "description": "Schema for container image promotion receipts generated by the promote-release workflow",
  "type": "object",
  "required": ["promotion", "inputs", "outputs", "verification", "sanity_check"],
  "additionalProperties": false,
  "properties": {
    "promotion": {
      "type": "object",
      "description": "Metadata about the promotion event",
      "required": ["timestamp", "workflow_run", "triggered_by"],
      "additionalProperties": false,
      "properties": {
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp of promotion",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$",
          "examples": ["2024-01-15T14:30:00Z"]
        },
        "workflow_run": {
          "type": "string",
          "description": "Full URL to the GitHub Actions workflow run",
          "pattern": "^https://github\\.com/.+/.+/actions/runs/\\d+$",
          "examples": ["https://github.com/afewell-hh/hoss/actions/runs/1234567890"]
        },
        "triggered_by": {
          "type": "string",
          "description": "GitHub username who triggered the promotion",
          "pattern": "^[a-zA-Z0-9]([a-zA-Z0-9-]{0,37}[a-zA-Z0-9])?$",
          "examples": ["afewell-hh"]
        }
      }
    },
    "inputs": {
      "type": "object",
      "description": "Inputs provided to the promotion workflow",
      "required": ["image", "digest", "tag", "allow_non_semver"],
      "additionalProperties": false,
      "properties": {
        "image": {
          "type": "string",
          "description": "OCI repository path (must be ghcr.io)",
          "pattern": "^ghcr\\.io/.+/.+$",
          "examples": ["ghcr.io/afewell-hh/hoss/hhfab"]
        },
        "digest": {
          "type": "string",
          "description": "SHA256 digest (64 hex chars, no prefix)",
          "pattern": "^[0-9a-f]{64}$",
          "examples": ["a1b2c3d4e5f67890123456789012345678901234567890abcdefabcdefabcdef"]
        },
        "tag": {
          "type": "string",
          "description": "Target tag for promotion",
          "pattern": "^[A-Za-z0-9._-]+$",
          "examples": ["v1.0.0", "v2.3.4-rc.1", "stable", "latest"]
        },
        "allow_non_semver": {
          "type": "boolean",
          "description": "Whether non-SemVer tags were allowed (policy bypass)",
          "examples": [false, true]
        }
      }
    },
    "outputs": {
      "type": "object",
      "description": "Outputs produced by the promotion workflow",
      "required": ["tag_reference", "digest_reference", "resolved_manifest_digest"],
      "additionalProperties": false,
      "properties": {
        "tag_reference": {
          "type": "string",
          "description": "Full OCI reference with tag (image:tag)",
          "pattern": ":[^:@]+$",
          "examples": ["ghcr.io/afewell-hh/hoss/hhfab:v1.0.0"]
        },
        "digest_reference": {
          "type": "string",
          "description": "Full OCI reference with digest (image@sha256:...)",
          "pattern": "@sha256:[0-9a-f]{64}$",
          "examples": ["ghcr.io/afewell-hh/hoss/hhfab@sha256:a1b2c3d4..."]
        },
        "resolved_manifest_digest": {
          "type": "string",
          "description": "Resolved manifest digest after promotion (sha256:...)",
          "pattern": "^sha256:[0-9a-f]{64}$",
          "examples": ["sha256:a1b2c3d4e5f67890123456789012345678901234567890abcdefabcdefabcdef"]
        }
      }
    },
    "verification": {
      "type": "object",
      "description": "Cosign signature verification details",
      "required": ["cosign_verified", "certificate_info"],
      "additionalProperties": false,
      "properties": {
        "cosign_verified": {
          "type": "boolean",
          "description": "Whether cosign verification passed",
          "const": true
        },
        "certificate_info": {
          "type": "string",
          "description": "Extracted cosign certificate metadata",
          "minLength": 1,
          "examples": ["Certificate subject: https://github.com/afewell-hh/hoss/..."]
        }
      }
    },
    "sanity_check": {
      "type": "object",
      "description": "Post-promotion sanity check results",
      "required": ["passed", "command", "output"],
      "additionalProperties": false,
      "properties": {
        "passed": {
          "type": "boolean",
          "description": "Whether the sanity check passed",
          "const": true
        },
        "command": {
          "type": "string",
          "description": "Command executed during sanity check",
          "const": "hhfab version"
        },
        "output": {
          "type": "string",
          "description": "Output from the sanity check command",
          "minLength": 1,
          "examples": ["hhfab v0.41.3\nBuild: 2024-01-15T14:00:00Z"]
        }
      }
    }
  }
}
